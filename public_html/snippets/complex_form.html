<!DOCTYPE html>
<html>
<head>
	<title>Geraint Anderson Web Development</title>
	<meta name="keywords" content="Geraint, Anderson, web, developer, development, html, html5, css, css3, javascript, portfolio">
	<meta name="description" content="Online portfolio for Geraint Anderson">
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
	<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
	<script>
		$(document).ready(function(){
			$('#top_navbar').load("../top_nav_subdir.txt");
		});
	</script>
	<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
	<link rel="stylesheet" type="text/css" href="../main.css">
	<style>
		label{
			display: inline-block;
			width:150px;
			font-size: 1.1em;
			margin: 1px;
			padding: 1px;
		}
		#form input{
			width: 150px;
			margin: 1px;
			padding: 1px;
		}
		pre{
			width: 100%;
			overflow-x: scroll;
			display: inline-block;
		}
		.scroll{
			height: 200px;
			overflow-y: scroll;
			display: inline-block;
		}
	</style>
	<script>
		function getFormFields(reset){
			/* This creates a new line for the form to add a new member */
			if (reset){
				var memberCount = 0;
			} else {
				/* Get current number of members on the form */
				var memberCount = $('.member_data').length;
			}

			return '<span class="member_data"><input type="text" name="members[' + memberCount + '][name]"><input type="text" name="members[' + memberCount + '][date]"></span><br>';
		}

		$(document).ready(function(){
			$('#dynamic_form').html(getFormFields());
			$('#form').submit(function(e){
				e.preventDefault();

				$.post("http://geraintanderson.com/cgi-bin/complex_form.py",
				$('#form').serialize(),
				function(data, status){
					$('#member_info').html(data);
					$('#dynamic_form').html(getFormFields(true));
				});
			});

			$('#new_member').click(function(){
				$('#dynamic_form').append(getFormFields());
			});
		});
	</script>
</head>
<body>
	<nav class="navbar navbar-default">
		<div id="top_navbar" class="container-fluid">
		</div>
	</nav>

	<div class="container">
		<h2>Complex dynamic forms</h2>
		<p>While working on an activity logging system I needed a way of grouping various fields on a form together.  This example needs to record which date goes with which date.  The convention is to name the form inputs similar to arrays.  Here the first line of inputs are named <code>members[0][name]</code> and <code>members[0][date]</code>.  The number for new inputs is easily incremented using JQuery to count the existing inputs and generate a new line.  A python script loops through the inputs in order and does any server side work (in this case not much).</p>
		<form id="form">
			<h3>Group Name</h3>
			<input type="text" name="group_name"><br>
			<h3>Members</h3>
			<button type="button" id="new_member">New member</button>
			<br><label for="name">Name</label><label for="date">Date</label>
			<div id="dynamic_form">
				<!--<span class="member_data"><input type="text" name="name"><input type="text" name="date"></span><br>-->
			</div>
			<input type="submit">
		</form>
		<div id="member_info"></div>
		<h2>Decoding the Form Data</h2>
			<p>In this example I'm not doing anything special with the form data, and I know beforehand exactly what I'm going to get.  Each member will have exactly one name and one date, and I'm just returning them with a bit of html.  There are situations where I might need to do some more server side processing but the data isn't very well structured yet.  I have written the following code to convert the POST parameters into a python dictionary.  This handles sub documents and arrays.</p>
			<code><pre class="scroll">
def get_key_name(str):
	first_pos = str.find('[')
	return str[:first_pos]

def get_subkey_name(str):
    '''Used with lists of dictionaries only'''
    first_pos = str.rfind('[')
    last_pos = str.rfind(']')
    return str[first_pos:last_pos+1]

def get_key_index(str):
    first_pos = str.find('[')
    last_pos = str.find(']')
    return str[first_pos:last_pos+1]

def decode(idic):
    odic = {} # Initialise an empty dictionary
    # Scan all the top level keys
    for key in idic:
        # Nested entries have [] in their key
        if '[' in key and ']' in key:
            if key.rfind('[') == key.find('[') and key.rfind(']') == key.find(']'):
                print key, 'is a nested list'
                key_name = get_key_name(key)
                key_index = int(get_key_index(key).replace('[','',1).replace(']','',1))
                # Append can't be used because we may not get the list in the correct order.
                try:
                    odic[key_name][key_index] = idic[key][0]
                except KeyError: # List doesn't yet exist
                     odic[key_name] = [None] * (key_index + 1)
                     odic[key_name][key_index] = idic[key][0]
                except IndexError: # List is too short
                     odic[key_name] = odic[key_name] + ([None] * (key_index - len(odic[key_name]) + 1 ))
                     # TO DO: This could be a function
                     odic[key_name][key_index] = idic[key][0]
            else:
                key_name = get_key_name(key)
                key_index = int(get_key_index(key).replace('[','',1).replace(']','',1))
                subkey_name = get_subkey_name(key).replace('[','',1).replace(']','',1)
                try:
                    odic[key_name][key_index][subkey_name] = idic[key][0]
                except KeyError: # Dictionary doesn't yet exist
                    print "KeyError"
                    # The dictionaries must not be bound to the same object
                    odic[key_name] = [{} for _ in range(key_index+1)]
                    odic[key_name][key_index][subkey_name] = idic[key][0]
                except IndexError: # List is too short
                    # The dictionaries must not be bound to the same object
                    odic[key_name] = odic[key_name] + [{} for _ in range(key_index - len(odic[key_name]) + 1)]
                    odic[key_name][key_index][subkey_name] = idic[key][0]
        else:
            # This can be added to the output dictionary directly
            print key, 'is a simple key value pair'
            odic[key] = idic[key][0]
    return odic
			</pre></code>
			<p>For the members example in this page it creates a dictionary containing a list of members which allows it to be used with all the standard tools:</p>
			<pre><code>
members = {[
	{ name : 'Geraint', date : 'Today'},
	{ name : 'Bob', date : 'Yesterday'}
]}
			</code></pre>
		</div>
	</div>

	<div class="center-text">
		<a id="twittershare" href="https://twitter.com/share" class="twitter-share-button" data-via="Geraint_TJ_A">Tweet</a>
	</div>
		<hr>
		<div class="center-text">
			Created by <a href="mailto:geraint@geraintanderson.com">Geraint Anderson</a>
		</div>
	</div>
</body>
</html>
